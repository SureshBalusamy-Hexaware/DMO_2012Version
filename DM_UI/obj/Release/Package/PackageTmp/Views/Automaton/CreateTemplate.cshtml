@{
    ViewBag.Title = "DataType Template";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@Scripts.Render("~/Scripts/AutomationCommon.js")

<style type="text/css">
    #hint {
        cursor: pointer;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        background-color: black;
        z-index: 99;
        opacity: 0.8;
        filter: alpha(opacity=80);
        -moz-opacity: 0.8;
        min-height: 100%;
        width: 100%;
    }

    .loadingprogress {
        font-family: Arial;
        font-size: 10pt;
        border: 5px solid #67CFF5;
        width: 200px;
        height: 100px;
        display: none;
        position: fixed;
        background-color: White;
        z-index: 999;
    }

    .ui-widget {
        font-size: 13px;
    }

    .ui-tooltip {
        background: green;
        color: white;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
    }
</style>
<script src="~/Scripts/jquery-ui-1.11.4.min.js"></script>

<script type="text/javascript">
    $(document).ready(function () {

        baseUrl = '@Url.Content("~/")';

        $("#hdnClientId").val('@ViewData["ClientID"]');
        $("#hdnProjectId").val('@ViewData["ProjectID"]');
        $("#hdnToolID").val('@ViewData["ToolID"]');

        $('#TransformListtable').hide();
        $('#btngeneratexml').hide();
        $("#transdesc").hide();
        $("#translist").hide();

        $('#selecttransformation').attr('trigger', 'change');

        InitializingGrid(0, '');

        $("#select_existing_Template").hide();
        $("#divSourcetable").hide();
        $("#divTransformListtable").hide();
        $("#lnkNewTemplate").hide();

        var $radios = $('input:radio[name=rdb]');
        if ($radios.is(':checked') === false) {
            $radios.filter('[value=Source]').prop('checked', true);
        }

        $('#btnrulehower').tooltip({
            track: true,
        });

        $("#divdbl").dblclick(function () {

            Reset();

            if (!$('#select_existing_Template').is(':visible')) {
                $('#select_existing_Template').show();
                $("#txttemplate").hide();
                $("#hdnMode").val("Edit");
                $("#lnkNewTemplate").show();

                if ($('#select_existing_Template > option').length <= 1) {
                    LoadDataTemplate('DataType', function (data) {
                        $('#select_existing_Template').html('');
                        $('#select_existing_Template').append($('<option>').text("Select"));
                        $.each(data, function (index, value) {
                            var template = value.split(':');
                            var tempname = template[0];
                            var tempid = template[1];
                            // if (tempname != '')
                            $('#select_existing_Template').append($('<option>').text(tempname).val(tempid));
                        });
                    });
                }

            }
            else {
                $('#select_existing_Template').hide();
                $("#txttemplate").show();
                $("#hdnMode").val("New");
            }
        });

        LoadSourceTarget('SOURCE', function (data) {
            $('#sourceConnection').html('');
            $('#sourceConnection').append($('<option>').text('Select').val('Select'));
            $.each(data, function (index, value) {
                var name = value.split(',');
                var ServerName = name[0];
                var ConfigId = name[1];
                $('#sourceConnection').append($('<option>').text(ServerName).val(ConfigId));
            });
        });
        LoadSourceTarget('TARGET', function (data) {
            $('#TargetConnection').html('');
            $.each(data, function (index, value) {
                var name = value.split(',');
                var ServerName = name[0];
                var ConfigId = name[1];
                $('#TargetConnection').append($('<option>').text(ServerName).val(ConfigId));
            });
        });
     

        $('#select_existing_Template').on('change', function (e) {
            var optionSelected = $("option:selected", this);
            var valueSelected = this.value;

            if (valueSelected == 'Select') {
                Reset();
                return;
            }

            $('#hdntemplateid').val(valueSelected);
            $("#divSourcetable").show();
            $("#divTransformListtable").show();

            var TemplateID = $('#select_existing_Template option:selected').val();
            var TemplateName = $('#select_existing_Template option:selected').text();

            if (TemplateName == "Select" || TemplateName == "") {
                TemplateName = '';
                TemplateID = 0;
            }

            InitializingGrid(TemplateID, TemplateName);

            $("#sourceConnection")[0].selectedIndex = 1;
            $("#TargetConnection")[0].selectedIndex = 0;

            GetTransTableList();
            GetTransformationTransType();

            bindTableList("Targetable", $("#TargetConnection option:selected").val(), true);
            bindTableList("Sourcetable", $("#sourceConnection option:selected").val(), true);

            $("#Sourcetable").prop("disabled", true);
            $("#sourceConnection").prop("disabled", true);
            $("#TargetConnection").prop("disabled", true);

            $("#transdesc").show();
            $("#translist").show();

        });
        $('#selecttransformation').on('change', function () {
            $("#btnrulehower").attr("title", $('#selecttransformation option:selected').attr("Key"));
        });
        $('#sourceConnection').on('change', function () {
            var TemplateName = $('#select_existing_Template').is(':visible') ? $('#select_existing_Template option:selected').text() : $('#txttemplate').val();
            TemplateName = TemplateName.toUpperCase() == 'SELECT' ? '' : TemplateName;

            if (TemplateName == '') {
                alert('Please enter template name');
                $('#sourceConnection').val('Select');
                return;
            }
            var servername = $('#sourceConnection option:selected').text().split(':')[1]
            $('#Sourcetable').val('');

            bindTableList("Sourcetable", $("#sourceConnection option:selected").val());
        });
        $('#selectTranstable').on('change', function () {

            $('#selecttranscolumn').html('');
            var TemplateName = $('#select_existing_Template').is(':visible') ? $('#select_existing_Template option:selected').text() : $('#txttemplate').val();
            TemplateName = TemplateName.toUpperCase() == 'SELECT' ? '' : TemplateName;

            $.ajax({
                type: "GET",
                url: baseUrl + "api/AutomatAPI/GetSourceTargetColumnsByTableName",
                data: { Client_ID: $("#hdnClientId").val(), Project_ID: $("#hdnProjectId").val(), Tool_ID: $("#hdnToolID").val(), TemplateName: TemplateName, TableName: $('#selectTranstable option:selected').text(), type: 'TRANS' },
                dataType: 'json',
                success: function (data) {
                    $.each(data, function (index, value) {
                        var column = value.split(':');
                        var clmname = column[0];
                        var cmlid = column[1];
                        $('#selecttranscolumn').append($('<option>').text(clmname).val(cmlid));
                    });
                    if (localStorage.getItem("transclmn") != '') {
                        $("#selecttranscolumn").val(localStorage.getItem("transclmn"));
                        localStorage.setItem("transclmn", "");
                    }
                }
            });

        });


        $('#Sourcetable').on('change', function () {
            var tablename = this.value;
            var FieldType = "SOURCE"
            $('#hdnsrcconnectionid').val($('#sourceConnection option:selected').val());

            var databaseIP = $('#sourceConnection option:selected').text().split(':')[0];
            var connection_id = $('#hdnsrcconnectionid').val();
            var ServiceUrl = baseUrl + "api/AutomatAPI/GetTableDataDetail";
            $("#divSourcetable").show();
            $('#SourcetableGrid').jqGrid('clearGridData');
            var grid = jQuery("#SourcetableGrid");
            var reccount = 0;//grid.getGridParam("reccount")

            $('#txtTargetable').val('');
            $.ajax({
                type: "GET",
                url: ServiceUrl,
                data: {
                    client_ID: $("#hdnClientId").val(), project_ID: $("#hdnProjectId").val(), Database_IP: databaseIP, Table_Name: tablename,
                    connectionid: connection_id, Field_Type: FieldType, Recordcount: reccount, tgtConnectionid: $('#TargetConnection option:selected').val()
                },
                dataType: "json",
                contentType: "application/json",
                success: function (data) {
                    var grid = jQuery("#SourcetableGrid");
                    var reccount = grid.getGridParam("reccount") + 1
                    for (i = 0; i < data.length; i++) {
                        grid.jqGrid('addRowData', reccount + i, data[i], "last");
                    }

                    $("#sp_1_pager_datatable").text("1");
                    if (data.length > 0) {
                        $("#txtTargetable").val(data[0].Target_Table_Name);
                    }
                }
            });

        });

        $('#btnsavesource').click(function () {
           

            var TemplateName = $('#select_existing_Template').is(':visible') ? $('#select_existing_Template option:selected').text() : $('#txttemplate').val();
            TemplateName = TemplateName.toUpperCase() == 'SELECT' ? '' : TemplateName;
            var TemplateID = $('#hdntemplateid').val();

            if (TemplateName == '') {
                alert('Please enter template name');
                return;
            }

            if ($('#txtTargetable').val() == '') {
                alert('Target table is empty');
                return;
            }

            $("#lodingMessage").hide();
            ShowProgress();

            var data = {};
            var grid = $("#SourcetableGrid");
            var rows = grid.jqGrid('getDataIDs');
            var SourceEntity = [];
            var TargetEntity = [];
            $.each(rows, function (i, l) {

                var rowData = grid.jqGrid('getRowData', rows[i]);
                var seqno = rowData['Field_Seq_No'];
                if (rowData['Field_Seq_No'].indexOf("input") != -1) {
                    seqno = jQuery('#' + (l) + '_Field_Seq_No').val();
                }

                if (seqno == "0") {
                    return;
                }
                SourceEntity.push({
                    Client_ID: $("#hdnClientId").val(),
                    Project_ID: $("#hdnProjectId").val(),
                    Connection_ID: $('#sourceConnection option:selected').val(),
                    Template_Id: $('#hdntemplateid').val(),
                    Table_Name: rowData['Table_Name'],
                    Template_Name: TemplateName,
                    Field_Seq_No: seqno,
                    Field_Data: rowData['Field_Data'],
                    Field_Name: rowData['Column_Name'],
                    Field_Data_Type: rowData['Data_Type'],
                    Field_Prec: rowData['Data_Precision'],
                    Field_Scale: rowData['Data_Scale'],
                    Field_Key: rowData['Key_column'],
                    Field_Type: rowData['Field_Type'],
                    Row_ID: rowData['Row_ID'],
                    Create_Date: Date.now(),
                    Modified_Date: Date.now(),
                    Created_By: '@ViewData["UserName"]'
                });
            });

            $.ajax({
                type: "POST",
                data: JSON.stringify(SourceEntity),
                url: baseUrl + "Api/AutomatAPI/SaveSourceGrid",
                dataType: "json",
                async: false,
                contentType: "application/json",
                success: function (data) {
                    if ($('#hdntemplateid').val() == "") {
                        if ($('#hdnMode').val() == 'New') {
                            $('#hdntemplateid').val(data);
                            $('#select_existing_Template').append($('<option>').text(TemplateName).val(data));
                        }
                    }
                }
            });
            TemplateID = $('#hdntemplateid').val();
            SaveTargetGrid();
            InitializingSourceGrid(TemplateID, TemplateName);
            GetTransTableList();
            GetTransformationTransType(); 
            
            $('#btngeneratexml').show();
            alert('Records saved successfully.');
            HideProgress();

            $("#txttemplate").prop('disabled', true);
            $("#Sourcetable").prop("disabled", true);
            $("#sourceConnection").prop("disabled", true);
            $("#TargetConnection").prop("disabled", true);
            $("#lnkNewTemplate").show();

        });

        function SaveTargetGrid() {

            var TemplateName = $('#select_existing_Template').is(':visible') ? $('#select_existing_Template option:selected').text() : $('#txttemplate').val();
            TemplateName = TemplateName.toUpperCase() == 'SELECT' ? '' : TemplateName;
            var TemplateID = $('#hdntemplateid').val();
          


            var data = {};
            var grid = $('#SourcetableGrid');
            var rows = grid.jqGrid('getDataIDs');
            var SourceEntity = [];
            $.each(rows, function (i, l) {
                var rowData = grid.jqGrid('getRowData', rows[i]);
                var seqno = rowData['Field_Seq_No'];
                if (rowData['Field_Seq_No'].indexOf("input") != -1) {
                    seqno = jQuery('#' + (l) + '_Field_Seq_No').val();
                }

                if (seqno == "0") {
                    return;
                }

                SourceEntity.push({
                    Client_ID: $("#hdnClientId").val(),
                    Project_ID: $("#hdnProjectId").val(),
                    Connection_ID: $('#TargetConnection option:selected').val(),
                    Template_ID: TemplateID,
                    Table_Name: rowData['Target_Table_Name'],
                    Template_Name: TemplateName,
                    Field_Seq_No: seqno,
                    Field_Type: "TARGET",
                    Field_Name: rowData['Target_Column_Name'],
                    Field_Data_Type: rowData['Target_Data_Type'],
                    Field_Prec: rowData['Data_Precision'],
                    Field_Scale: rowData['Data_Scale'],
                    Field_Data: rowData['Field_Data'],
                    Field_Key: rowData['Key_column'],
                    Row_ID: rowData['Row_ID'],
                    Create_Date: Date.now(),
                    Modified_Date: Date.now(),
                    Created_By: '@ViewData["UserName"]'
                });
            });

            $.ajax({
                type: "POST",
                data: JSON.stringify(SourceEntity),
                async: false,
                url: baseUrl + "Api/AutomatAPI/SaveTargetGrid",
                dataType: "json",
                contentType: "application/json",
                success: function (data) {
                }
            });
            $("#transdesc").show();
            $("#translist").show();
        }

        $('#lnkNewTemplate').click(function () {
            Reset();
            $("#transdesc").hide();
            $("#translist").hide();
            $("#Sourcetable").prop("disabled", false);
            $("#sourceConnection").prop("disabled", false);
            $("#TargetConnection").prop("disabled", false);
            $('#lnkNewTemplate').hide();
            $('#select_existing_Template').hide();
            $("#txttemplate").show();
            $("#txttemplate").prop('disabled', false);
            $("#hdnMode").val("New");

        });
        $('#btnaddtrans').click(function () {

            $('#TransformListtable').show();

            var TemplateName = $('#select_existing_Template').is(':visible') ? $('#select_existing_Template option:selected').text() : $('#txttemplate').val();
            TemplateName = TemplateName.toUpperCase() == 'SELECT' ? '' : TemplateName;
            var TemplateID = $('#hdntemplateid').val();

            if ($('#hdntemplateid').val() == '' || $('#hdntemplateid').val() == '0') {
                alert('Please save the records');
                return;
            }

            if ($('#txttrans').val() == '') {
                alert('Please enter transformation name');
                return;
            }
            if ($('#selectTranstable option:selected').text() == 'Select') {
                alert('Please select table');
                return;
            }
            if ($('#selecttranscolumn option:selected').text() == 'Select') {
                alert('Please select column');
                return;
            }

            var TransOrderNo = 0;
            var grid = $('#TransformListtable');
            var rows = grid.jqGrid('getDataIDs');

            $.each(rows, function (i, l) {
                var rowData = grid.jqGrid('getRowData', rows[i]);
                var TransOrder = rowData['Trans_Order'];
                if (TransOrder.indexOf("input") != -1) {
                    TransOrder = jQuery('#' + (l) + '_Trans_Order').val();
                }
                TransOrderNo = TransOrder;
            });
            TransOrderNo = parseInt(TransOrderNo) + 1;

            if ($('#txtTransOrder').val() != "") {

                if ($.isNumeric($('#txtTransOrder').val())) {
                    TransOrderNo = $('#txtTransOrder').val();
                }
            }

            var TransitionAdd = {
                Client_ID: $("#hdnClientId").val(),
                Project_ID: $("#hdnProjectId").val(),
                TemplateName: TemplateName,
                Template_ID: TemplateID,
                Trans_ID: $("#hdnTransformationID").val(),
                TransName: $('#txttrans').val(),
                TransType: $('#selecttransformation option:selected').text(),
                TableName: $('#selectTranstable option:selected').text(),
                ColumnName: $('#selecttranscolumn option:selected').text(),
                TransRule: $('#txtTransRule').val(),
                TransOrder: TransOrderNo,
                SourceConnectionID: $('#TargetConnection option:selected').val(),
                TargetConnectionID: $('#sourceConnection option:selected').val()
            };

            $.ajax({
                type: "POST",
                url: baseUrl + "Api/AutomatAPI/SaveTransTable",
                data: JSON.stringify(TransitionAdd),
                dataType: "json",
                contentType: "application/json",
                success: function (data) {

                    alert('Transformation saved successfully.');
                    $("#divTransformListtable").show();
                    InitializingTransformationGrid(TemplateID, TemplateName);
                    $('#hdnTransformationID').val("");
                    $('#txttrans').val("");
                    $('#txtTransRule').val("");
                    $('#txtTransOrder').val("");
                    $("#btnaddtrans").attr('value', 'Save');
                    $("#btnCanceltrans").attr('value', 'Clear');
                }
            });
        });
        $("#btnCanceltrans").click(function () {
            $('#hdnTransformationID').val("");
            $('#txttrans').val("");
            $('#txtTransRule').val("");
            $('#txtTransOrder').val("");
            $("#btnaddtrans").attr('value', 'Save');
            $("#btnCanceltrans").attr('value', 'Clear');
        });
        $('#btnreset').click(function () {
            Reset();
        });
        $("#btnTemplateParameters").click(function () {
            var TemplateName = $('#select_existing_Template').is(':visible') ? $('#select_existing_Template option:selected').text() : $('#txttemplate').val();
            TemplateName = TemplateName.toUpperCase() == 'SELECT' ? '' : TemplateName;
            $("#txtParameterTemplateName").val(TemplateName);
            $("#dialog").dialog("open");
            LoadParameterList();
        });
        $("#btnCancelParameter").click(function () {
            $('#ddlparameterName').val("");
            $('#txtParameterValue').val("");
            $('#hdnParameterID').val("");
            //$("#dialog").dialog('close');
        });
        $('#btngeneratexml').click(function () {
            $("#lodingMessage").show();
            ShowProgress();
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GenerateXML")',
                dataType: 'json',
                data: { Template_ID: $('#hdntemplateid').val() },
                success: function (data) {
                    HideProgress();
                    $("#lbldisplaypath").text("Package saved path: " + data[1]);
                    alert(data[0]);
                },
                error: function (xhr) {
                    HideProgress();
                    alert(xhr);
                }
            });
        });

        function GetTransformationTransType()
        {
            debugger;
            var lengthTransType = $('#selecttransformation > option').length;
            if(lengthTransType == 0)
            { GetTransformationType(); }

        }
        function GetTransTableList() {

            $('#selectTranstable').empty();
            $('#selectTranstable').append($('<option>').text('Select').val('Select'));

            var TemplateName = $('#select_existing_Template').is(':visible') ? $('#select_existing_Template option:selected').text() : $('#txttemplate').val();
            TemplateName = TemplateName.toUpperCase() == 'SELECT' ? '' : TemplateName;

            $.ajax({
                type: "GET",
                url: baseUrl + "api/AutomatAPI/GetSourceTargetTable",
                data: { Client_ID: $("#hdnClientId").val(), Project_ID: $("#hdnProjectId").val(), Tool_ID: $("#hdnToolID").val(), TemplateName: TemplateName, type: 'TRANS' },
                dataType: 'json',
                success: function (data) {
                    $.each(data, function (index, value) {
                        var table = value.split(':');
                        var tblname = table[0];
                        var tblid = table[1];
                        $('#selectTranstable').append($('<option>').text(tblname).val(tblid));
                    });
                }
            });
        }
        function bindTableList(_ControlID, _Config_ID, _setValue) {

            $('#' + _ControlID).empty();
            $('#' + _ControlID).append($('<option>').text('Select').val('Select'));
            $.ajax({
                type: "GET",
                url: baseUrl + "api/AutomatAPI/GetMetaDataTableNames",
                data: { client_ID: $("#hdnClientId").val(), project_ID: $("#hdnProjectId").val(), config_ID: _Config_ID, },
                dataType: 'json',
                success: function (data) {
                    $.each(data, function (index, value) {
                        var name = value.split(':');
                        var tablename = name[0];
                        var databasename = name[1];
                        $('#' + _ControlID).append($('<option>').text(tablename).val(tablename));
                    });

                    if (_setValue) {

                        if (_ControlID == 'Sourcetable') {
                            var grid = $("#SourcetableGrid");
                            var rowCount = grid.jqGrid('getGridParam', 'records');

                            if (rowCount) {
                                $("#Sourcetable").val(grid.jqGrid('getCell', 1, 'Table_Name'));
                            }
                        }
                        else {
                            var grid = $("#SourcetableGrid");
                            var rowCount = grid.jqGrid('getGridParam', 'records');

                            if (rowCount)
                                $("#txtTargetable").val(grid.jqGrid('getCell', 1, 'Target_Table_Name'));
                        }
                    }
                }
            });
        }
        function InitializingGrid(TemplateID, TemplateName) {

            //var templateid = TemplateID   
            //            if (templateid == 0) {   
            //                     return;   
            //                } 

            InitializingSourceGrid(TemplateID, TemplateName);
            InitializingTransformationGrid(TemplateID, TemplateName);
        }
        function InitializingSourceGrid(TemplateID, TemplateName) {

            $("#SourcetableGrid").GridUnload();
            var ServiceUrl = baseUrl + "api/AutomatAPI/GetTemplateSourceRecords";
            $grid = jQuery("#SourcetableGrid").jqGrid({
                mytype: 'GET',
                datatype: 'json',
                url: ServiceUrl,
                height: 230,
                width: 200,
                autowidth: true,
                shrinkToFit: true,
                rowNum: 1000,
                rowList: [10, 20, 30],
                postData: {
                    client_ID: $("#hdnClientId").val(), project_ID: $("#hdnProjectId").val(), Template_Id: TemplateID,
                    Template_Name: TemplateName, SourceTargetType: 'SOURCE'
                },
                colNames: ['Seq No', 'Table Name', 'Field Name', 'Data Type', 'Precision','Scale', 'Table Name', 'Column Name', 'DataType', 'Field Type', 'Row ID', 'Target Row ID'],
                colModel: [
               { name: 'Field_Seq_No', index: 'Field_Seq_No', type: 'long', width: 8, sorttype: 'long', search: true, editable: true },
               { name: 'Table_Name', index: 'Table_Name', width: 20, search: true },
               { name: 'Column_Name', index: 'Column_Name', width: 20, search: true },
               { name: 'Data_Type', index: 'Data_Type', width: 20, search: true },
               { name: 'Data_Precision', index: 'Data_Precision', width: 20, search: false ,hidden:true },
               { name: 'Data_Scale', index: 'Data_Scale', width: 20, search: false, hidden: true },
               { name: 'Target_Table_Name', index: 'Target_Table_Name', width: 20, search: true },
               { name: 'Target_Column_Name', index: 'Target_Column_Name', width: 20, search: true },
               { name: 'Target_Data_Type', index: 'Target_Data_Type', width: 20, search: true },
               { name: 'Field_Type', index: 'Field_Type', width: 20, search: false, hidden : true },
               { name: 'Row_ID', index: 'Row_ID', width: 20, hidden: true },
               { name: 'Target_Row_ID', index: 'Target_Row_ID', width: 20, hidden: true }
                ],
                multiselect: false,
                pager: '#pager_datatable',
                viewrecords: true,
                loadonce: true,
                gridview: true,
                //scrollOffset: 0,
                reloadAfterSubmit: true,
                showButtonPanel: true,
                loadui: "disable",
                ignoreCase: true,
                loadComplete: function () {
                },
                onSelectRow: function (rowId) {
                    var rowData = $('#SourcetableGrid').jqGrid('getRowData', rowId);
                    jQuery('#SourcetableGrid').jqGrid('editRow', rowId, true);
                },
                gridComplete: function () {
                    $(this).prop('p').loadui = 'enable';
                }
            });

            jQuery("#SourcetableGrid").jqGrid('setGroupHeaders', {
                useColSpanStyle: true,
                groupHeaders: [
                  { startColumnName: 'Table_Name', numberOfColumns: 3, titleText: 'Source' },
                  { startColumnName: 'Target_Table_Name', numberOfColumns: 3, titleText: 'Target' }
                ]
            });

            jQuery("#SourcetableGrid").jqGrid("filterToolbar", { stringResult: true, searchOnEnter: false, defaultSearch: "cn", clearSearch: true, groupOp: "OR" });

            var sourceBgColor = "#24b3b5";
            var targetBgColor = "#1C94C6";
            var GroupHeaderHeight = "36px";
            var RowColumntargetHeight = "32px";

            $('th[class="ui-state-default ui-th-column-header ui-th-ltr"]').each(function () {

                if ($(this).text() == "Target") {
                    this.style.color = "white";
                    this.style.background = targetBgColor;
                    this.style.height = GroupHeaderHeight;
                    this.style.fontSize = "13px";
                } else if ($(this).text() == "Source") {

                    this.style.color = "white";
                    this.style.background =sourceBgColor;
                    this.style.height = GroupHeaderHeight;
                    this.style.fontSize = "13px";
                }
            });

            $('th[class="ui-state-default ui-th-column ui-th-ltr"]').each(function () {


                if ($(this).attr("ID") == "SourcetableGrid_Table_Name") {
                    this.style.color = "white";
                    this.style.background = sourceBgColor;
                    this.style.height = RowColumntargetHeight;
                }

                if ($(this).attr("ID") == "SourcetableGrid_Column_Name") {
                    this.style.color = "white";
                    this.style.background = sourceBgColor;
                    this.style.height = RowColumntargetHeight;
                }


                if ($(this).attr("ID") == "SourcetableGrid_Data_Type") {
                    this.style.color = "white";
                    this.style.background = sourceBgColor;
                    this.style.height = RowColumntargetHeight;
                }


                if ($(this).attr("ID") == "SourcetableGrid_Target_Table_Name") {
                    this.style.color = "white";
                    this.style.background = targetBgColor;
                    this.style.height = RowColumntargetHeight;
                }


                if ($(this).attr("ID") == "SourcetableGrid_Target_Column_Name") {
                    this.style.color = "white";
                    this.style.background = targetBgColor;
                    this.style.height = RowColumntargetHeight;
                }


                if ($(this).attr("ID") == "SourcetableGrid_Target_Data_Type") {
                    this.style.color = "white";
                    this.style.background = targetBgColor;
                    this.style.height = RowColumntargetHeight;
                }
                if ($(this).attr("ID") == "SourcetableGrid_Field_Type") {
                    this.style.color = "white";
                    this.style.background = targetBgColor;
                    this.style.height = RowColumntargetHeight;
                }
            });
        }
        function InitializingTransformationGrid(TemplateID, TemplateName) {
            $("#TransformListtable").GridUnload();
            var TransformatiomServiceUrl = baseUrl + "api/AutomatAPI/GetTransTemplateList";

            $grid = jQuery("#TransformListtable").jqGrid({
                mytype: 'POST',
                datatype: 'json',
                url: TransformatiomServiceUrl,
                height: 150,
                width: 1250,
                autowidth: true,
                shrinkToFit: false,
                rowNum: 1000,
                rowList: [10, 20, 30],
                postData: { client_ID: $("#hdnClientId").val(), project_ID: $("#hdnProjectId").val(), TemplateName: TemplateID },
                colNames: ['Trans Order', 'Trans Type', 'Trans Description', 'Trans Rule', 'Trans Table', 'Trans Column', 'Data Type', 'Length', 'Trans_ID'],
                colModel: [
                    { name: 'Trans_Order', index: 'Trans_Order', width: 100, editable: true },
                    { name: 'Trans_Type', index: 'Trans_Type', width: 150 },
                    { name: 'Trans_Name', index: 'Trans_Name', width: 350 },
                    { name: 'Trans_Rule', index: 'Trans_Rule', width: 350 },
                    { name: 'Table_Name', index: 'Table_Name', width: 150, },
                    { name: 'Field_Name', index: 'Field_Name', width: 150 },
                    { name: 'Field_Data_Type', index: 'Field_Data_Type', width: 80, hidden: true },
                    { name: 'Field_Length', index: 'Field_Length', width: 50, hidden: true },
                    { name: 'Trans_ID', index: 'Trans_ID', width: 20, hidden: true }],
                multiselect: false,
                pager: '#pager_transformdatatable',
                viewrecords: true,
                loadonce: true,
                gridview: true,
                scrollOffset: 0,
                reloadAfterSubmit: true,
                showButtonPanel: true,
                loadui: "disable",
                loadComplete: function () {
                },
                onSelectRow: function (rowId) {
                    //var rowData = $('#TransformListtable').jqGrid('getRowData', rowId);
                    //jQuery('#TransformListtable').jqGrid('editRow', rowId, true);
                },
                gridComplete: function () {
                    $(this).prop('p').loadui = 'enable';
                },
                caption: 'Transformation'
            });

            jQuery("#TransformListtable").jqGrid('navGrid', '#pager_transformdatatable', {
                edit: true, add: false, del: false, search: false, refresh: false,
                edittext: 'Edit',
                deltext: 'Delete',
                editfunc: function (rowid) {

                    $("#hdnTransformationID").val($.trim($grid.jqGrid('getCell', rowid, 'Trans_ID')));
                    $("#txttrans").val($.trim($grid.jqGrid('getCell', rowid, 'Trans_Name')));
                    $("#selecttransformation").val($.trim($grid.jqGrid('getCell', rowid, 'Trans_Type')));
                    $("#txtTransRule").val($.trim($grid.jqGrid('getCell', rowid, 'Trans_Rule')));
                    $("#selectTranstable").val($.trim($grid.jqGrid('getCell', rowid, 'Table_Name')));
                    $("#txtTransOrder").val($.trim($grid.jqGrid('getCell', rowid, 'Trans_Order')));
                    //$("#selecttranscolumn").val($.trim($grid.jqGrid('getCell', rowid, 'Field_Name')));
                    localStorage.setItem("transclmn", $.trim($grid.jqGrid('getCell', rowid, 'Field_Name')))
                    $("#txttrans").focus();
                    $("#btnaddtrans").attr('value', 'Update');
                    $("#btnCanceltrans").attr('value', 'Cancel');
                    $('#selectTranstable').trigger("change");

                }
            },
           {
               closeOnEscape: true,
               closeAfterEdit: true,
               afterComplete: function (response) {
                   if (response.responseText) {
                       alert(response.responseText);
                   }
               },
               afterSubmit: function () {
                   $(this).jqGrid("setGridParam", { datatype: 'json' });
                   return [true];
               }
           },
           {
               closeOnEscape: true,
               closeAfterEdit: true,
               afterComplete: function (response) {

                   if (response.responseText) {
                       alert(response.responseText);
                   }
               }
           },
           {
               closeOnEscape: true,
               closeAfterEdit: true,
               recreateForm: true,
               afterComplete: function (response) {
                   if (response.responseText) {
                       if (response.responseText == 'Deleted successfully.')
                           ShowMessage(response.responseText, 'success');
                       else ShowMessage(response.responseText, 'failed');
                   }
               }
           });

        }
        function LoadParameterList() {

            var tablename = this.value;
            var ServiceUrl = baseUrl + "api/AutomatAPI/GetTemplateParameterData";

            var TemplateName = $('#select_existing_Template').is(':visible') ? $('#select_existing_Template option:selected').text() : $('#txttemplate').val();;
            TemplateName = TemplateName.toUpperCase() == 'SELECT' ? '' : TemplateName;

            $('#ParameterListtable').show();
            $("#ParameterListtable").GridUnload();
            $grid = jQuery("#ParameterListtable").jqGrid({
                mytype: 'POST',
                datatype: 'json',
                url: ServiceUrl,
                height: 150,
                width: 550,
                autowidth: true,
                shrinkToFit: true,
                editurl: baseUrl + 'Automaton/ParameterUpdate',
                rowNum: 10,
                rowList: [10, 20, 30],
                prmNames: { id: "Parameter_ID" },
                postData: { client_ID: $("#hdnClientId").val(), project_ID: $("#hdnProjectId").val(), TemplateName: TemplateName },
                colNames: ['Parameter_ID', 'Parameter Name', 'Parameter Value'],
                colModel: [
                     { name: 'Parameter_ID', index: 'Parameter_ID', width: 150, key: true, hidden: true },
                { name: 'Parameter_Name', index: 'Parameter_Name', width: 100 },
                { name: 'Parameter_Value', index: 'Parameter_Value', width: 250 }
                ],
                multiselect: false,
                pager: '#pager_ParameterListtable',
                viewrecords: true,
                loadonce: true,
                gridview: true,
                scrollOffset: 0,
                reloadAfterSubmit: true,
                showButtonPanel: true,
                pginput: true,
                pgbuttons: true,
                loadui: "disable",
                loadComplete: function () {
                },
                gridComplete: function () {
                    $(this).prop('p').loadui = 'enable';
                },
                caption: 'Parameters'
            });

            jQuery("#ParameterListtable").jqGrid('navGrid', '#pager_ParameterListtable', {
                edit: true, add: false, del: false, search: false, refresh: false,
                edittext: 'Edit',
                deltext: 'Delete',
                editfunc: function (rowid) {

                    //var _txtParameterName = $("#txtParameterName");
                    var _txtParameterValue = $("#txtParameterValue");

                    $("#ddlparameterName").val($.trim($grid.jqGrid('getCell', rowid, 'Parameter_Name')));
                    _txtParameterValue.val($.trim($grid.jqGrid('getCell', rowid, 'Parameter_Value')));
                    $("#hdnParameterID").val(rowid);
                    //_txtParameterName.focus();
                }
            },
           {
               closeOnEscape: true,
               closeAfterEdit: true,
               afterComplete: function (response) {
                   if (response.responseText) {
                       alert(response.responseText);
                   }
               },
               afterSubmit: function () {
                   $(this).jqGrid("setGridParam", { datatype: 'json' });
                   return [true];
               }
           },
           {
               closeOnEscape: true,
               closeAfterEdit: true,
               afterComplete: function (response) {

                   if (response.responseText) {
                       alert(response.responseText);
                   }
               }
           },
           {
               closeOnEscape: true,
               closeAfterEdit: true,
               recreateForm: true,
               afterComplete: function (response) {
                   if (response.responseText) {
                       if (response.responseText == 'Deleted successfully.')
                           ShowMessage(response.responseText, 'success');
                       else ShowMessage(response.responseText, 'failed');
                   }
               }
           });

        }
        function Reset() {


            $('#hdntemplateid').val('');
            $('#txttemplate').val('');
            $('#txtTransRule').val('');
            $('#txttrans').val('');
            $('#Sourcetable').empty();
            $('#txtTargetable').val('');
            $('#selectTranstable').empty();
            $('#selecttranscolumn').empty();

            $('#sourceConnection').val('Select');
            $("#divSourcetable").show();
            $("#divTransformListtable").show();

            InitializingGrid(0, '');

            $("#divSourcetable").hide();
            $("#divTransformListtable").hide();
            $("#select_existing_Template").prop('selectedIndex', 0);

            $('#hdnTransformationID').val("");
            $('#txttrans').val("");
            $('#txtTransRule').val("");
            $('#txtTransOrder').val("");
            $("#btnaddtrans").attr('value', 'Save');
            $("#btnCanceltrans").attr('value', 'Clear');
            localStorage.setItem("transclmn", "");
            $("#transdesc").hide();
            $("#translist").hide();
        }
        function ShowProgress() {
            debugger;
            setTimeout(function () {
                var modal = $('<div />');
                modal.addClass("modal");
                var loading = $(".loadingprogress");
                loading.show();
                var top = Math.max($(window).height() / 2 - loading[0].offsetHeight / 2, 0);
                var left = Math.max($(window).width() / 2 - loading[0].offsetWidth / 2, 0);
                loading.css({ top: top, left: left });
            }, 200);
        }
        function HideProgress() {
            debugger;
            setTimeout(function () {
                var modal = $('<div />');
                modal.addClass("modal");
                var loading = $(".loadingprogress");
                loading.hide();
                var top = Math.max($(window).height() / 2 - loading[0].offsetHeight / 2, 0);
                var left = Math.max($(window).width() / 2 - loading[0].offsetWidth / 2, 0);
                loading.css({ top: top, left: left });
            }, 200);
        }

        $('#btnaddParameter').click(function () {

            var TemplateName = $('#select_existing_Template').is(':visible') ? $('#select_existing_Template option:selected').text() : $('#txttemplate').val();
            TemplateName = TemplateName.toUpperCase() == 'SELECT' ? '' : TemplateName;

            if (TemplateName == '') {
                alert('Please enter template name');
                return;
            }


            if ($('#hdntemplateid').val() == '') {
                alert('Please Save Template');
                return;
            }


            if ($('#ddlparameterName').val() == '') {
                alert('Please enter Parameter name');
                return;
            }

            if ($('#txtParameterValue').val() == '') {
                alert('Please enter Parameter Value');
                return;
            }

            var ParameterAdd = {
                Parameter_ID: $("#hdnParameterID").val(),
                Client_ID: $("#hdnClientId").val(),
                Project_ID: $("#hdnProjectId").val(),
                Template_Name: TemplateName,
                Template_ID: $('#hdntemplateid').val(),
                Parameter_Name: $('#ddlparameterName').val(),
                Parameter_Value: $('#txtParameterValue').val(),
                Created_By: '@ViewData["UserName"]',
                Tool_ID: $("#hdnToolID").val()
            };

            $.ajax({
                type: "POST",
                url: baseUrl + "Api/AutomatAPI/SaveParameter",
                data: JSON.stringify(ParameterAdd),
                dataType: "json",
                contentType: "application/json",
                success: function (data) {
                    alert('Successfully added Parameter Values');
                    LoadParameterList();

                    $('#txtParameterValue').val("");
                    $('#hdnParameterID').val("");

                }
            });
        });


       

        $("#dialog").dialog({
            autoOpen: false,
            modal: true,
            width: 900,
            height: 450,
            beforeClose: function (event, ui) {
                $('#hdnParameterID').val("");
            }
        });
    });

</script>

<div class="table-div">
    <div class="loadingprogress" align="center">
        <span id="lodingMessage" style="display:none;">Generating xml.</span> Please wait.<br />
        <br />
        <img src="../Images/loader.gif" alt=" " />
    </div>
    <table>
        <tr>
            <td>
                <div class="div-header">
                    <span class="control-label label-bold" style="font-size:20px;"><b>DataType Template</b></span>
                </div>
            </td>
        </tr>
    </table>
    <table style="border:thick;">
        <tr>
            <td class="table-div-page1-cl1">
                <span id="labeltable" class="fontstyle">Template Name</span>
            </td>
            <td class="table-div-page1-cl2">
                <div id="divdbl" style="width: 100%; white-space: nowrap;">
                    <input id="txttemplate" type="text" style="width:84%" class="textbox" />
                    <select id="select_existing_Template" class="dropdown" style="width:90%;"></select>
                    <a id="lnkNewTemplate" class="control-label" style="color:blue;" href="#" title="click here to create a new template">[New Template]</a>
                </div>
            </td>
            <td class="table-div-page2-cl1"></td>
            <td class="table-div-page2-cl2"></td>
        </tr>
        <tr>
            <td class="table-div-page1-cl1">
                <label for="tablename" id="labelcol" class="fontstyle">Connection</label>
            </td>
            <td class="table-div-page1-cl2">
                <select id="sourceConnection" class="dropdown">
                    <option style="margin:20px;" value="area1">Select</option>
                </select>
            </td>
            <td class="table-div-page2-cl1">
                <label for="tablename" class="fontstyle">Source Table</label>
            </td>
            <td class="table-div-page2-cl2">
                <select id="Sourcetable" class="dropdown"></select>
            </td>
        </tr>
    </table>
    <table>
        <tr>
            <td class="table-div-page1-cl1">
                <span id="labeltable" class="fontstyle">Target Connection</span>
            </td>
            <td class="table-div-page1-cl2">
                <select id="TargetConnection" class="dropdown"></select>
            </td>
            <td class="table-div-page2-cl1"><span id="labeltable" class="fontstyle">Target Table</span></td>
            <td class="table-div-page2-cl2">
                <input id="txtTargetable" type="text" style="width:85%" class="textbox" readonly />
            </td>
        </tr>
    </table>
    <table>
        <tr>
            <td>
                <div id="divSourcetable">
                    <table id="SourcetableGrid" class="scroll" align='center'></table>
                    <div id="pager_datatable" class="scroll"></div>
                </div>
            </td>
        </tr>
        <tr><td colspan="4" style="text-align:right"></td></tr>
    </table>

    <table>
        <tr>
            <td colspan="4" style="text-align:right">
                <div>
                    <input type="button" id="btnsavesource" value="Save" class="button btn-width-150">
                </div>
            </td>
        </tr>
    </table>
    <table id="transdesc">
        <tr>
            <td class="table-div-page1-cl1"><span id="labeltable" class="fontstyle">Transformation Description</span></td>
            <td class="table-div-page1-cl2" colspan="4"><input type="text" id="txttrans" class="textbox" /></td>
        </tr>
        <tr>
            <td class="table-div-page1-cl1"><label for="tablename" id="labelcol" class="fontstyle">Transformation Type</label></td>
            <td class="table-div-page1-cl2"><select id="selecttransformation" class="dropdown"></select></td>
            <td class="table-div-page2-cl1">
                <span id="labeltable" class="fontstyle">Trans Rule</span>
            </td>
            <td class="table-div-page2-cl2">
                <input type="text" id="txtTransRule" class="textbox" style="width:75%" /><input type="button" id="btnrulehower" class="button" value="?" />
            </td>
            <td>
                <label for="tablename" id="labelcol" class="fontstyle"></label><br />
            </td>
        </tr>
        <tr>
            <td class="table-div-page1-cl1">
                <span id="labeltable" class="fontstyle">Table</span>
            </td>
            <td class="table-div-page1-cl2">
                <select id="selectTranstable" class="dropdown">
                    <option style="margin:20px;" value="area1">Select</option>
                </select>
            </td>
            <td class="table-div-page2-cl1">
                <label for="tablename" id="labelcol" class="fontstyle">Column</label>
            </td>
            <td class="table-div-page2-cl2">
                <select id="selecttranscolumn" class="dropdown"><option style="margin:20px;" value="area1">Select</option></select>
            </td>
            <td></td>
        </tr>
        <tr>
            <td class="table-div-page1-cl1"><span id="labeltable" class="fontstyle">Transformation Order</span></td>
            <td class="table-div-page1-cl2"><input type="text" id="txtTransOrder" class="textbox" width="100" /></td>
            <td class="table-div-page1-cl1"></td>
            <td class="table-div-page1-cl2" colspan="2">
                <div style="float:right;">
                    <input type="button" id="btnaddtrans" value="Save" class="button btn-width-150" />
                    <input type="button" id="btnCanceltrans" value="Clear" class="button btn-width-150" />
                </div>
            </td>
        </tr>
    </table>
    <table id="translist">
        <tr>
            <td>
                <div id="divTransformListtable">
                    <table id="TransformListtable" class="scroll" align='center'></table>
                    <div id="pager_transformdatatable" class="scroll"></div>
                </div>
            </td>
        </tr>
        <tr>
            <td colspan="4" style="text-align:left;">
                <div class="form-btn-row" style="margin:28px">
                    <br />
                    <div style="float:right">
                        <input type="button" id="btnvalidate" value="Validate" class="button btn-width-150" style="display:none" />
                        <input type="button" id="btnTemplateParameters" value="Define Parameters" class="button btn-width-150" />
                        <input type="button" id="btnreset" value="Reset" class="button btn-width-150" />
                        <input type="button" id="btngeneratexml" value="Generate XML" class="button btn-width-150" />
                        <input type="button" id="btnback" value="Back" class="button btn-width-150" onclick="@("window.location.href='" + @Url.Action("Configuration", "Automaton") + "'");" />
                        <br />
                        <span id="lbldisplaypath" class="fontstyle"></span>
                        <input type="hidden" id="hdntypesource" />
                        <input type="hidden" id="hdntypelookup" />
                        <input type="hidden" id="hdntemplateid" />
                        <input type="hidden" id="hdnsrcconnectionid" />
                        <input type="hidden" id="hdntrtconnectionid" />
                        <input type="hidden" id="hdnTargetTables" />
                        <input type="hidden" id="hdnMode" value="New" />
                        <input type="hidden" value="@ViewData["ClientID"]" id="hdnClientId" />
                        <input type="hidden" value="@ViewData["ProjectID"]" id="hdnProjectId" />
                        <input type="hidden" value="@ViewData["ConfigID"]" id="hdnConfigID" />
                        <input type="hidden" value="@ViewData["ToolID"]" id="hdnToolID" />
                        <input type="hidden" id="hdnTransformationID" />
                    </div>
                </div>
                <br /><br />
            </td>
        </tr>
    </table>

</div>

<div id="dialog" title="Define Parameters" style="display: none; font-size: 12px">
    <table>
        <tr>
            <td colspan="4"><b>Template Name</b> &nbsp; <input type="text" id="txtParameterTemplateName" style="width:580px" class="textbox" disabled /></td>
        </tr>
        <tr>
            <td><b>Parameter Name</b> </td>
            <td>
                <select id="ddlparameterName" class="dropdown">
                    <option value="SRC_Query">Source Query </option>
                    <option value="SRC_Query2">Join Query</option>
                    <option value="LKP_Query">Lookup Query </option>
                    <option value="LKP_Columns">Lookup Columns</option>
                    <option value="Variables">Variables</option>
                </select>
            </td>
            <td><b>Parameter Value</b> </td>
            <td><textarea name="txtParameterValue" id="txtParameterValue" style="width:300px" class="textbox"></textarea> </td>
        </tr>
        <tr>
            <td colspan="3"></td>
            <td>
                <div style="float:right">
                    <input type="button" id="btnaddParameter" value="Save" class="button btn" />
                    <input type="button" id="btnCancelParameter" value="Clear" class="button btn" />
                    <input type="hidden" value="" id="hdnParameterID" />
                </div>
            </td>
        </tr>
        <tr>
            <td></td>
        </tr>
    </table>
    <table id="ParameterListtable" align='center'></table>
    <div id="pager_ParameterListtable" class="scroll"></div>
</div>
